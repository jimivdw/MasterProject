\chapter{Problem analysis}
\chlab{analysis}

In this chapter, we introduce the problems we aim to solve in this project. We start by providing a brief explanation of the chemical concepts behind molecule parameterisation~(\secref{chemical}). This is followed by the interaction design challenges for a fragment-based molecule parameterisation system in \secref{id_challenges}.



\section{Chemical concepts}
\seclab{chemical}
Every material is built up out of molecules, consisting of a set of atoms. Each of these atoms has a certain type, such as hydrogen~($H$) or carbon~($C$). The atoms of a molecule are connected via bonds, where there can be multiple bonds between the same atoms. Every atom has a certain charge, which can be positive or negative, and is usually fractional. The molecule itself also has a charge, consisting of the sum of all its individual atom charges.

\begin{wrapfigure}{r}{.4\textwidth}
\vspace{-2em}
\begin{center}
\includegraphics[width=.38\textwidth]{img/ethanamine.pdf}
\caption{Schematic view of ethanamine ($C_{2}H_{7}N$)~\cite{atb2014ethanamine}, including topology data on atom types, atomic charges and charge groups.}
\figlab{partial_charges}
\end{center}
\vspace{-2em}
\end{wrapfigure}

As discussed in the introduction (\chref{introduction}), biomolecular simulations are becoming increasingly important, especially in the field of drug development. For these simulations, force field models are required to describe the interatomic relations of the drug molecules. In order to run a simulation, these force fields require the molecule's topology, which consists of the molecule's atom types, bonds, bond angles, atomic charges and charge groups.

\Figref{partial_charges} shows a schematic view of an ethanamine molecule. Here, every oval symbolises an atom. The atom type is the letter on the top rule of the oval, i.e.\ $H$ is the atom type of the oval containing the text $H7 (6)$. The first number indicates the index in the list of atoms of that type ($7$ in the example), the second the overall atom index in the molecule ($6$ in the example). The bonds between atoms are shown as lines between the ovals and the atomic charges are given by the number at the bottom row of the oval ($0.37$ for $H7 (6)$). Finally, the colouring of the atoms and the boxes around them denote a charge group. This is a group of connected atoms, for which the total charge is ideally equal to that of the whole molecule ($0.0$ in this example).

In a recent study, El-Kebir, Klau et al. have developed an algorithm that allows for fast and reliable assignment of charge groups~\cite{canzar2012charge}. As this is now optimised, they currently focus on a different step in the parameterisation: that of calculating the atomic partial charges. Currently, these charges are retrieved using complex quantum-mechanical calculations. However, when run on larger molecules, these calculations can take hours or even days to complete. As it is not believed that the algorithms used in these calculations can be improved much further, a different approach is needed for finding atom charges.

\begin{figure}[b!]
\centering
\makebox[\linewidth][c]{%
\begin{subfigure}[t]{0.5\textwidth}
\centering
\includegraphics[width=.8\textwidth]{img/match_target.pdf}
\caption{Match target.}
\figlab{match_target}
\end{subfigure}%
\begin{subfigure}[t]{0.5\textwidth}
\centering
\includegraphics[width=.8\textwidth]{img/match_none.pdf}
\caption{Non-matching fragment.}
\figlab{match_none}
\end{subfigure}%
}\\[1em]
\makebox[\linewidth][c]{%
\begin{subfigure}[t]{0.5\textwidth}
\centering
\includegraphics[width=.8\textwidth]{img/match_good.pdf}
\caption{Matching fragment.}
\figlab{match_good}
\end{subfigure}%
\begin{subfigure}[t]{0.5\textwidth}
\centering
\includegraphics[width=.8\textwidth]{img/match_bad.pdf}
\caption{Matching fragment.}
\figlab{match_bad}
\end{subfigure}%
}
\caption{Basic fragment matching.}
\figlab{matching}
\end{figure}

A possible alternative method of finding atom charges is to exploit the similarity of molecules. The partial charges of an unparameterised molecule can be retrieved from similar fragments of other molecules for which the charges \emph{are} known. In \figref{matching}, the basics of fragment matching are shown. In this case, we are looking for an $N$ atom, with two connected $H$ atoms and a connected $C$ (see \figref{match_target}). As can clearly be seen, \figref{match_none} is not a match, as there are two $C$s connected to the $N$ atom there, and only one $H$. \Figref{match_good, match_bad} show two different fragments that \emph{do} match the target fragment. The $N$ atoms in both molecules are connected to a $C$ and two $H$ atoms. We will discuss fragment matching in more detail in \secref{impl_omfraf}.

\begin{todo}
\item Replace with fragment matching from presentation;
\item Update discussion of why it is hard to find charges with reference to matches.
\end{todo}

For an atom, or a set of atoms, usually many matching fragments will be found. Which of those fragments is the best match depends on many factors, including the fragment size and type of molecule they originate from. Due to this, it is currently not possible to fully automate fragment-based parameterisation. Instead, it needs to be done by experienced chemists who have the knowledge about which fragments match well, and which do not. A system is needed that assists them in this process, and allows them to easily compare fragments and molecules.



\section{Interaction Design challenges}
\seclab{id_challenges}
A system for fragment-based molecule parameterisation is not readily available. Therefore, a new system needs to be designed from the ground up. This allows for creating something completely new, but also creates the challenge of doing it right without having any clear starting point. Therefore, two different versions of the system will be implemented, such that they can be compared in order to validate them.

Both implementations need to meet the same set of requirements. First of all, the system needs to provide its users with a view of the unparameterised atom, and help them to find the best matching fragments. As the selected fragments may not always be perfect, it should also be possible for the users to manually adjust the charges for each atom, if they feel that this is needed.

In order to find the best available matching fragment, the users should be able to easily compare the found matching fragments, both with each other and with the unparameterised molecule. They should be encouraged to compare as many fragments as possible, such that they do not miss the best one. When many fragments are found, the best matches should be easily recognisable. Otherwise, fully parameterising the molecule may take up too much time, or that fragment may not be found at all. This requires the found fragments to be presented to the user in a clear and intuitive way.

Another important requirement for the system is that is should support parameterisation of both small molecules, consisting of just a few atoms, and large molecules, being over a hundred atoms in size. This means that visualisation of the molecules should be given some thought, in order to make sure both large and small atoms are displayed correctly. It is particularly challenging to find a way to properly visualise large molecules on a screen with a limited size, so an approach should be developed that allows for this.

Overall, the most important requirement for the system is to make it work intuitively and to implement it such that it makes chemists' work easier. Parameterising a large molecule should therefore not take hours to complete. Even if that would still be faster than calculating the charges, one can at least do something else while the computations are running. This, of course, is not possible while manually parameterising.
