\chapter{Implementation}
\chlab{implementation}


% Max. one figure at top of page
\setcounter{topnumber}{1}
\setcounter{bottomnumber}{1}
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.9}
\renewcommand{\textfraction}{0.1}


A system for fragment-based molecule parameterisation has three distinct tasks: visualising a molecule, finding matching fragments for that molecule, and allowing for interaction with the molecule and its matching fragments. As these tasks can be performed in isolation, it has been decided to implement the molecule parameterisation tool as three separate systems.

The front-end of the system, where users will carry out the parameterisation process, will be called the Online tool for Fragment-based Molecule Parameterisation~(\oframp). This name will also be used to refer to the system as a whole, as it is the hart of the system and is dependent on the other systems. The molecule is also visualised in \oframp, but the for this purpose essential, calculations of atom positions are done in the Online tool for Atom Position Calculations~(\oapoc). Finally, finding matching fragments and sorting them based on relevance is done by the Online tool for Molecule Fragment Finding~(\omfraf).

The complete network diagram for the fragment-based molecule parameterisation system is shown in \figref{network_diagram}. It is clear that \oframp{} is the central system, but that the more computation-intensive tasks are carried out by \oapoc{} and \omfraf{}. The remainder of this chapter will discuss each of the systems in more detail.


\begin{sidewaysfigure}[p]
\begin{center}
\includegraphics[width=\textwidth]{img/network_diagram.pdf}
\vspace{1em}
\caption{Network diagram of \oframp and its supporting systems.}
\figlab{network_diagram}
\end{center}
\end{sidewaysfigure}


\section[\oframp]{The Online tool for Fragment-based Molecule Parameterisation}
\oframp{} is the central part of the fragment-based molecule parameterisation system. It contains the user interface and connects with \oapoc{} and \omfraf{}. As discussed in \secref{platform}, it has been decided to implement the system as a web application. Following the current trend in web applications, \oframp{} has been implemented using the latest techniques from \verb|HTML5|, \verb|CSS3| and \verb|JavaScript|.

Using the latest web technologies allows for great cross-platform support. It allows the system to run on any desktop and laptop operating system, and creates the possibility of running it on a smartphone or tablet\footnote{This has not been a requirement for the project and has therefore not been tested extensively.}, without requiring any modifications. Still, of course, the limited size of a smartphone screen can be problematic, but it can at least run.

Making use of the latest \verb|HTML5| technologies, however, also comes at a cost. Older browsers generally lack support, and will therefore not be able to run \oframp. Luckily, according to the latest browser statistics from StatCounter~\cite{statcounter2014statcounter}, almost 85\% of internet users uses a browser that has full support for these technologies. Thanks to many compatibility libraries and especially the Internet Explorer \verb|canvas| fallback \verb|excanvas|~\cite{arvidsson2009explorercanvas}, partial support can be provided for browsers used by an additional 11\% of people. In total, this means that 96\% of internet users should be able to run \oframp. A complete list of system requirements can be found in \secref{client_req}.

\subsection{Getting started}

Upon loading \oframp{} for the first time, one should see something similar to what is shown in \figref{impl_welcome}. It is explained what the tool is, and what it should be used for. Additionally, instructions are provided for first-time users and pointers are provided to the help pages. From this point, users can either start a short demonstration guide~(see \secref{impl_demo}) or submit a new molecule into the system~(see \secref{impl_inserting}).

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/impl_welcome.png}
\caption{\oframp{} welcome screen.}
\figlab{impl_welcome}
\end{center}
\end{figure}

\Figref{impl_welcome} also shows the basic design of the system. It has been decided to go for a minimal look with a simple, purely textual logo. Besides the pastel colours of the logo, all text uses a dark shade of grey. Boxes and buttons all have a white background and a light grey, slightly rounded border.

Overly designed shiny elements are known to distract the user from his tasks~\cite{norman1990interfaces}~(see also \secref{design}). In some cases this may be beneficial, but for the purpose of finding a good molecule parameterisation this is undesirable. Therefore, this minimal design tries to make sure the user stays focused on the task that he needs to perform, rather than on using the tool. Furthermore, the tool still looks good and decent, which should prevent the users from distrusting it due to poor design~\cite{norman2002emotion}~(see also \secref{design}).

\subsubsection{Submitting a molecule}
\seclab{impl_inserting}

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/impl_inserting.png}
\caption{Insertion window for molecule data strings.}
\figlab{impl_inserting}
\end{center}
\end{figure}

In \figref{impl_inserting}, the insertion window for molecules is shown. This is where users should submit the molecules in a machine readable format, the so called molecule data string~(MDS). As discussed before, the system supports the \verb|PDB|, \verb|SMILES|, and \verb|InChI| formats, and the use of \verb|ATB ID|s~(see \secref{id_common}). When the MDS has been entered, the user can click the `Submit' button, after which the molecule will be displayed~(see \secref{impl_visualisation}).

Additionally, the user can adjust the fragment repository and shell size that are to be used for finding matching fragments of other molecules. The available repositories are retrieved from \omfraf~(see \secref{impl_omfraf}). This will be explained in more detail in \secref{impl_generating}. Furthermore, the demonstration mode~(see \secref{impl_demo}) can be started from this window as well, in case the user accidentally clicked the wrong button in the previous step. Finally, the user can load a so called \oframp{} State Storage~(OSS) file. These files can be created at any point in the parameterisation process and will store all progress up until that point. They can be loaded again at a later stage to continue the parameterisation process from that point.


\subsection{Visualisation}
\seclab{impl_visualisation}
Once a molecule data string has been entered into the system, the positions of its atoms and the connections between them are retrieved from \oapoc~(see \secref{impl_oapoc}). This data is then transformed to a \verb|JavaScript| \verb|Molecule| instance, as can be seen in \figref{oframp_class}. \verb|Molecule| instances can be visualised using a \verb|MoleculeViewer|, which will draw the molecule onto an \verb|HTML| \verb|canvas|.

\begin{figure}
\begin{center}
\includegraphics[width=\textwidth]{img/oframp_class.pdf}
\caption{Simplified class diagram of \oframp.}
\figlab{oframp_class}
\end{center}
\end{figure}

Upon entering the \verb|SMILES| MDS \verb|NCC(=O)CCO| into \oframp, one should see something resembling what is shown in \figref{impl_visualising}. Similar to the molecule visualisation of the ATB~(see \figref{partial_charges} on \figpageref{partial_charges}), atoms are displayed as circles containing the atom type and with connecting lines that denote bonds. However, there are also a number of differences. First of all, charge group information is missing here, as these cannot be found before the atomic charges are available. Second, atom IDs (both on molecule and type scale) are left out. These are not considered to add any helpful information, and can therefore only be confusing. Third, obviously, the atom charges are missing, as they have not yet been assigned. As soon as a matching fragment is selected, they will also be added to the visualisation~(see \secref{impl_parameterisation}). Fourth, as can be seen at the bottom-most \verb|O| atom, double bonds are visualised properly as a double line. The same is true for triple bonds that show as a triple line, and aromatic bonds that are indicated with a dotted line on the inside of the aromatic cycle they are a part of~(see also \secref{ormaybeanimage}).

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/impl_visualising.png}
\caption{\oframp{} visualisation of \texttt{NCC(=O)CCO}.}
\figlab{impl_visualising}
\end{center}
\end{figure}

Finally, what is probably the most notable difference, is the fact that the \verb|H| atoms are grouped with their base atoms\footnote{This, along with many other settings, can be altered. See \secref{impl_settings} for more information.}. This means that they do not need to be drawn separately, leaving more space around the other atoms, thereby enhancing the overview of the complete molecule. Furthermore, in chemistry, it is quite common to have this combination and, in many calculations, these groups can be treated as a single atom. As this does not hold for other atom types, those will not be grouped in the \oframp{} visualisation, to ensure chemical correctness.

\subsubsection{Interaction}
At this point, the molecule can already be interacted with. It can be moved around by holding down the \emph{left} mouse button and dragging the mouse. This is mostly useful for larger molecules that may not completely fit on smaller screens. To provide further support for large molecules, the user has the opportunity to zoom in on certain sections of the molecule, or zoom out to make more atoms fit on the screen. Zooming can be done using the mouse wheel, or the zoom buttons located in the advanced controls settings, which can be opened using the button with the down pointing arrow~(see \figref{impl_visualising}).


\subsubsection{Deoverlapping}
As discussed in \secref{ms_visualisation} and~\cite{clark2006structure}, overlap in atoms and bonds still occurs in modern molecule visualisation software. In this case, where the atoms have a relatively large radius to make room for displaying the charge, chances are even higher. To temper the effects of this, a simple deoverlap algorithm has been implemented. \Figref{impl_deoverlap} shows the three different types of deoverlapping that \oframp{} can do. Here, the light blue line indicates a vector that is used to determine if there is any overlap, the red line indicates the overlapping part, and the green arrow~(of equal length to the red line) shows where the atom centre should be moved to in order to resolve the overlap.

\begin{figure}
\begin{center}
\includegraphics[width=\textwidth]{img/deoverlap.pdf}
\caption{Concepts of deoverlap.}
\figlab{impl_deoverlap}
\end{center}
\end{figure}

By default, for performance reasons, only the deoverlapping of atoms is enabled. This is the easiest to detect and solve, but also the most important one. Atoms that overlap almost entirely might not be spotted by the user, and atom types and charges may become hidden due to another atom lying on top of them. As can be seen in \figref{impl_deoverlap}, this type of deoverlap works by calculating the distance between the two atom centres and subtracting the atom radius from that twice~(once for each atom). If this distance is smaller than $0$, both atom centres will be moved along the line that connects the two for a distance that is equal to the overlap distance. This ensures that the atoms will no longer overlap, and even creates some room between them.

In order to solve atoms overlapping bonds, the perpendicular distance from the atom centre to the bond needs to be calculated. When this distance is smaller than the atom radius, the atom needs to be moved along the perpendicular for a distance that is equal to the overlap distance. This will put the atom right next to the bond.

The third and final type of deoverlapping, the so-called decrossing of bonds, is also the hardest one. First, it needs to be determined if the two bonds intersect each other. When that is the case, the intersection point needs to be found. The overlap distance here is equal to the distance from the atom centre to the intersection point, plus the radius of the atom. The atom then needs to be moved along its bond for a distance that is equal to the overlap distance, in order to solve the crossing bonds.

Unfortunately, solving one occurrence of overlap could result in overlap occurring in a different place, as moving an atom could potentially move it on top of another. Therefore, the deoverlap process will need to repeat itself to solve all overlap in the molecule. However, it is possible that the solution of one overlap occurrence is the exact opposite of another, which means that, after two iterations, the situation will be exactly the same as it was initially. In order to prevent the deoverlap process from going into an endless loop because of this, a time limit~(set to half a second by default) has been built in, after which the deoverlapping will stop.

\subsection{Parameterisation}
\seclab{impl_parameterisation}
As soon as the matching fragments for the molecule have been generated, the `Loading fragments...' message as visible in \figref{impl_visualising} will go away. It is now possible to start the fragment-based parameterisation process. Two different implementations of this needed to be made, in order to find the best way of doing it. To allow for easy implementation of multiple interaction systems, a \verb|Behavior| interface has been created, which can be used to implement different behaviours~(see \figref{oframp_class}). The two implemented behaviours will be discussed in the next sections.

\subsubsection{Manual `naive' version}
In order to start the parameterisation process in the naive version of \oframp, a selection needs to be made. This selection can consist of a single atom or multiple \emph{connected} atoms, and should contain the atoms for which the user wants to find matching fragments. In order to make a single-atom selection, the user simply needs to click on that atom~(see \figref{select_1}). There are multiple ways to create multi-atom selections, the easiest of which is holding down the \emph{right} mouse button and dragging the mouse to create a selection rectangle as seen in \figref{select_2}. Alternatively, one could hold down the \verb|Ctrl| key while clicking atoms, or activate the selection modification mode, as seen in the selection details window in \figref{find_1}.

\begin{figure}
\centering
\begin{subfigure}[t]{0.45\textwidth}
\centering
\includegraphics[width=\textwidth]{img/select_1.png}
\caption{Making a single-atom selection.}
\figlab{select_1}
\end{subfigure}%
\qquad
\begin{subfigure}[t]{0.45\textwidth}
\centering
\includegraphics[width=\textwidth]{img/select_2.png}
\caption{Making a multi-atom selection.}
\figlab{select_2}
\end{subfigure}
\caption{\oframp{} atom selection.}
\figlab{selecting}
\end{figure}

When a selection has been made, matching fragments will automatically be retrieved from \omfraf~(see \secref{impl_omfraf}). These fragments will be shown in a sidebar on the right-hand side of the screen, and atom selection details will appear on the left-hand side~(see \figref{find_1}). Upon clicking a fragment, its charges will be previewed on the molecule~(see \figref{find_2}). The user then can decide if he wants to apply the charges of this fragment by clicking the `Select fragment' button that appears on the fragment, preview a different fragment by selecting another one, or inspect the fragment in the context of the molecule it originates from by clicking the `Show molecule' button.

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/find_1.png}
\caption{Found fragments.}
\figlab{find_1}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/find_2.png}
\caption{Previewing the second found fragment.}
\figlab{find_2}
\end{center}
\end{figure}

If the user clicks the `Select fragment' button, the charges from that fragment will be copied to the molecule. The selection will be cleared, and, because of that, the list of found fragments will be closed. The user can now select another atom or set of atoms he wants to parameterise, in order to complete the parameterisation. This will be discussed in more detail in \secref{impl_completing}.


\subsubsection{Semi-automatic `smart' version}
In the smart version of \oframp, the parameterisation process can be started by clicking the `Start parameterising' button shown in \figref{find_3}. The system will now automatically select a random atom \emph{at the edge of the molecule} for which fragments will be retrieved. The molecule will be centred on that molecule, and the charges of the best found fragment will be previewed~(see \figref{find_4}). In that figure, the atoms with the green background and the thicker border are the atoms occurring in the found fragment.

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/find_3.png}
\caption{Ready to start parameterisation.}
\figlab{find_3}
\end{center}
\end{figure}

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/find_4.png}
\caption{Previewing a found fragment.}
\figlab{find_4}
\end{center}
\end{figure}

The user now needs to decide whether he thinks this proposed fragment is a good match with the molecule. In order to help him to make this decision, he can view the fragment in the context of the molecule it originates from by clicking the `View original' button~(see \figref{find_4}). When he rejects the fragment, the next best fragment will be previewed, up until the point where there are no found fragments left. Either the final fragment needs to be accepted then, or the user can undo some of his rejections using the `Undo' button at the top of the page.

Upon acceptance of a fragment, the charges of that fragment are copied to the molecule. The system will then find another \emph{unparameterised} atom for which fragments will be proposed. This atom is preferably connected to the last accepted fragment, or, when no unparameterised atoms are neighbouring that fragment, positioned on the edge of the molecule. If neither of these atoms exist, a random unparameterised atom will be selected in a different part of the molecule. The user can now continue to parameterise the molecule, which will be discussed in more detail in \secref{impl_completing}.


\subsection{Completing parameterisation}
\seclab{impl_completing}
Upon continuing to parameterise a molecule, it is possible to encounter fragments that contain atoms to which a charge has already been assigned. The atoms in question are given a yellow background, as can be seen in \figref{conflict}. When such fragment is selected, it is dependent on which \oframp{} version is used what will happen. As discussed in \secref{}, the smart version will automatically assign the average of the two charges. In the naive version of the tool, pop-up will be shown, asking the user to pick a solution method for solving the charge conflict.

\begin{figure}
\begin{center}
\includegraphics[height=140px]{img/conflict.png}
\caption{Molecule with a charge conflict.}
\figlab{conflict}
\end{center}
\end{figure}

In some cases, it can happen that no matching fragments are found for an atom. This will be indicated by colouring that atom with a pink/red background, as can be seen for the rightmost $CH_{2}$ group in \figref{conflict}~(and also figures \ref{figure:selecting}, \ref{figure:find_1}, \ref{figure:find_2}, \ref{figure:find_3}, and \ref{figure:find_4}). Upon selecting these atoms, no fragments will be returned. It is still possible to parameterise them manually, in the same way one can fine-tune atom charges~(see \secref{impl_finetuning}).

When a charge has been assigned to all \emph{parameterisable} atoms~(i.e. atoms for which fragments can be found), the user will be notified of this with a pop-up similar to the one shown in \figref{finished}. As it says there, he can now fine-tune the atom charges~(see \secref{impl_finetuning}), download the resulting parameterisation~(see \secref{impl_downloading}), or enter a new molecule.

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/finished.png}
\caption{Notification of parameterisation completion.}
\figlab{finished}
\end{center}
\end{figure}


\subsubsection{Fine-tuning charges}
\seclab{impl_finetuning}
Charges of fragments of molecules will often not precisely match with the charges of another molecule. Therefore, the user has the ability to manually adjust atom charges when he wishes to do so. In order to do this, he needs to select the atoms he wishes to adjust the charges for. In the selection details panel, the `Show' button in the `Selected atoms' row should be clicked. A table containing detailed information about the atom will be shown, as can be seen in \figref{editing}.

\begin{figure}
\begin{center}
\includegraphics[width=.9\textwidth]{img/editing.png}
\caption{Manually fine-tuning or adding charges.}
\figlab{editing}
\end{center}
\end{figure}

The atom details table contains information about all atoms that are part of the selection. Hovering with the mouse over a row will highlight the corresponding atom in the molecule, which can be seen for the $O$ atom in \figref{editing}. The `Elem' column contains the atom element and its \verb|IACM atom type|~(in parentheses). The charge is shown, which can be edited by clicking the `Edit' button in the column next to it. Finally, clicking the `Show' button in the `Frags' column, will show the fragments that were used to get the current atom charge, as discussed in \secref{}.


\subsubsection{Downloading results}
\seclab{impl_downloading}
When the user feels he is completely done, he can download the resulting parameterisation of the molecule by clicking the `Download' button at the top of the page. This will give him the result in the \verb|LEMON Graph File|~(LGF) format~\cite{dezso2011lemon}. This format has been chosen as it is used by, among others, the fragment finding system~(see \secref{mop_fragments}), and because it is a flexible format that can easily be generated. This file will contain all atoms' element types, \verb|IACM| and charge, and all bonds between the atoms. It can currently not be imported back into the system, but support for that may be added at a later stage.


\subsection{Other features}
\nlipsum

\subsubsection{Demo mode}
\seclab{impl_demo}
\nlipsum

\subsubsection{Help}
\nlipsum

\subsubsection{Modifying visualisation parameters}
\seclab{impl_settings}
\nlipsum


\section[\oapoc]{The Online tool for Atom Position Calculations}
\seclab{impl_oapoc}
\nlipsum

\subsection{From ATB}
\nlipsum

\subsection{obabel}
\nlipsum


\section[\omfraf]{The Online tool for Molecule Fragment Finding}
\seclab{impl_omfraf}
\nlipsum

\subsection{Getting the repositories}
 by sending an empty \verb|JSON| object to its \verb|/repos| URL~(see \figref{network_diagram})
\nlipsum

\subsection{Generating fragments}
\seclab{impl_generating}
\nlipsum

\subsubsection{mop/fragments}
\nlipsum

\subsection{Finding fragments}
\nlipsum
